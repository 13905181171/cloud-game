<html>

<head>
  <!-- <meta name="viewport" content="width=device-width, user-scalable=no" /> -->
  <meta name="viewport" content="user-scalable=no" />
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.css" rel="stylesheet">
  <link href="/static/css/joystick.css" rel="stylesheet">
  <style>
    textarea {
      width: 60%;
      height: 50px;
    }
  </style>

</head>

<body>


  <select id="gameOp">
  </select>

  <button id="play" onclick="window.startGame()">Play</button>
  <button id="play" onclick="pc.close()">Stop</button>
  Your current room: <b><label id="currentRoomID" style="color:blue"></b> <br />
  You can join a remote game by roomID.<br />
  Room ID: <input type="text" id="roomID">
  Play as player(1,2): <select id="playerIndex">
    <option value="1">1</option>
    <option value="2">2</option>
  </select>

  <br /><br />

  <div id="remoteVideos">
    <video id="game-screen" autoplay=true width=400 height=300
      poster="https://orig00.deviantart.net/cdcd/f/2017/276/a/a/october_2nd___gameboy_poltergeist_by_wanyo-dbpdmnd.gif">
  </div> <br />

  <h3>Instruction</h3>
  <div>
    C is start button. Use it to start game<br />
    V is select button <br />

    Player 1
    Use Up, Down, Left, Right to Move <br />
    Z to (A) <br />
    X to (B) <br />
    S to save <br />
    L to load <br />
    <!--Fullscreen media for better gaming experience<br /-->
  </div><br>

  <h3>Log:</h3>
  <pre id="div"></pre>

  <div>
    ðŸŽ®<u><i>Refresh to retry when checking is too long</i></u>
  </div>


  <!-- virtual controller -->
  <div id="dpad" class="dpad">
    <span class="face up"></span>
    <span class="face down"></span>
    <span class="face left"></span>
    <span class="face right"></span>
  </div>

  <div class="abxy">
    <span class="button a"></span>
    <span class="button b"></span>
    <span class="button x"></span>
    <span class="button y"></span>
  </div>

  <script>
    DEBUG = true;
  </script>

  <!-- https://rawgit.com/Rillke/opus.js-sample/master/index.xhtml -->
  <script src="/static/js/libopus.js"></script>
  <script src="/static/js/opus.js"></script>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="/static/js/const.js"></script>
  <script src="/static/js/global.js"></script>
  <script src="/static/js/gameboy_controller.js"></script>
  <script src="/static/js/ws.js"></script>

  <script>
    $("#gameOp").on("change", function () {
      gameIdx = gameOp.selectedIndex;
    });

    gameIdx = 1;

    // virtual joystick
    // Ref: https://jsfiddle.net/aa0et7tr/5/
    createJoystick($('.dpad'));
    var dpadState = {};
    var touchIdx = null;

    function resetDPad() {
      dpadState = {
        up: false,
        down: false,
        left: false,
        right: false,
      };

      $(".dpad .face").removeClass("pressed");
    }

    function checkDPadAxis(bo, axis) {
      if (bo != dpadState[axis]) {
        dpadState[axis] = bo;
        
        if (dpadState[axis]) {
          $(`.dpad .${axis}`).addClass("pressed");
        } else {
          $(`.dpad .${axis}`).removeClass("pressed");
        }
      }
    }

    function createJoystick(parent) {
      const maxDiff = 50;
      
      stick = document.createElement('div');
      stick.classList.add('joystick');

      // parent.on('mousedown', handleMouseDown);
      // $(document).on('mousemove', handleMouseMove);
      // $(document).on('mouseup', handleMouseUp);

      parent.on('touchstart', handleMouseDown);
      parent.on('touchmove', handleMouseMove);
      parent.on('touchend', handleMouseUp);

      let dragStart = null;
      let currentPos = { x: 0, y: 0 };

      function handleMouseDown(event) {
        event.preventDefault();
        stick.style.transition = '0s';
        if (event.changedTouches) {
          touchIdx = event.changedTouches[0].identifier;
          dragStart = {
            x: event.changedTouches[0].clientX,
            y: event.changedTouches[0].clientY,
          };
          resetDPad();
          return;
        }
        dragStart = {
          x: event.clientX,
          y: event.clientY,
        };

      }

      function handleMouseMove(event) {
        event.preventDefault();
        if (dragStart === null) return;
        if (event.changedTouches) {
          event.clientX = event.changedTouches[touchIdx].clientX;
          event.clientY = event.changedTouches[touchIdx].clientY;
        }
        const xDiff = event.clientX - dragStart.x;
        const yDiff = event.clientY - dragStart.y;
        const angle = Math.atan2(yDiff, xDiff);
        const distance = Math.min(maxDiff, Math.hypot(xDiff, yDiff));
        const xNew = distance * Math.cos(angle);
        const yNew = distance * Math.sin(angle);
        stick.style.transform = `translate3d(${xNew}px, ${yNew}px, 0px)`;
        currentPos = { x: xNew, y: yNew };

        const xRatio = xNew / maxDiff;
        const yRatio = yNew / maxDiff;
        checkDPadAxis(xRatio <= -0.5, "left");
        checkDPadAxis(xRatio >= 0.5, "right");
        checkDPadAxis(yRatio <= -0.5, "up");
        checkDPadAxis(yRatio >= 0.5, "down");
      }

      function handleMouseUp(event) {
        event.preventDefault();
        if (dragStart === null) return;
        stick.style.transition = '.2s';
        stick.style.transform = `translate3d(0px, 0px, 0px)`;
        dragStart = null;
        currentPos = { x: 0, y: 0 };
        resetDPad();

        $(".abxy .button").removeClass("pressed");
      }

      parent.append(stick);
      return {
        getPosition: () => currentPos,
      };

    }


    function handleButtonDown(event) {
      $(this).addClass("pressed");
    }

    function handleButtonUp(event) {
      $(this).removeClass("pressed");
    }


    // $(".abxy .button").on("mousedown", handleButtonDown);
    // $(".abxy .button").on("mouseup", handleButtonUp);
    $(".abxy .button").on("touchstart", handleButtonDown);
    $(".abxy .button").on("touchend", handleButtonUp);
    

  </script>

</body>

</html>